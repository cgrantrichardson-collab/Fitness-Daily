<!doctype html>
<html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Fitness Daily — v21</title>
<meta name="theme-color" content="#000000">
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="favicon.png">
<style>
:root{
  --bg:#0b0d10; --panel:#12151b; --ink:#e6e6e6; --muted:#9aa3b2; --line:#22272e; --accent:#ff2424;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;z-index:5}
h1{margin:0;font-size:18px;letter-spacing:.5px}
main{max-width:1000px;margin:0 auto;padding:14px}
.row{display:flex;flex-wrap:wrap;gap:12px}
.card{flex:1 1 300px;background:#151922;border:1px solid var(--line);border-radius:10px;padding:14px}
.card h2{margin:0 0 10px 0;font-size:16px;letter-spacing:.3px}
.muted{color:var(--muted);font-size:13px}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px}
.btn{background:var(--accent);border:none;border-radius:8px;color:#fff;padding:8px 10px;font-weight:600;cursor:pointer;white-space:nowrap}
.btn.alt{background:#2a2f3a;border:1px solid var(--line);color:#eaeaea}
.btn:active{transform:translateY(1px)}
label{display:block;margin:10px 0 4px;font-size:13px;color:var(--muted)}
input[type='text'],input[type='number'],textarea,select{width:100%;background:#0f1116;border:1px solid var(--line);color:#e6e6e6;border-radius:8px;padding:10px 12px;font-size:15px}
textarea{min-height:64px;resize:vertical}
.setrow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.lift{border-top:1px dashed var(--line);padding-top:10px;margin-top:8px}
.quote{font-size:14px;line-height:1.45}
.quote b{color:var(--accent)}
canvas{width:100%;height:160px;background:#0f1116;border:1px solid var(--line);border-radius:8px}
.tabs{display:flex;gap:8px;margin:0 0 12px 0}
.tab{background:#0f1116;border:1px solid var(--line);color:#e6e6e6;padding:8px 12px;border-radius:8px;cursor:pointer}
.tab.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
.meal{border-top:1px dashed var(--line);padding-top:10px;margin-top:10px}
.mealhead{display:flex;align-items:center;gap:8px}
.mealgrid{display:grid;grid-template-columns:auto 1fr 110px 1fr;gap:8px;align-items:center;margin-top:8px}
.check{min-width:22px;min-height:22px}
.calRow{margin-top:8px;border-top:1px dashed var(--line);padding-top:12px;display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.macros b{display:inline-block;min-width:90px}
.smallmuted{color:#9aa3b2;font-size:12px}
/* bars */
.bar{width:220px;max-width:45vw;height:10px;background:#0e1116;border:1px solid var(--line);border-radius:999px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:8px}
.fill{height:100%;background:var(--accent);width:0%}
.targetBadge{font-size:12px;color:#c9d1d9;margin-left:6px}
/* Splash */
#splash{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s}
.splashText{font-weight:900;line-height:.9;text-align:center;letter-spacing:2px;
  font-size:clamp(40px,15vw,22vh);
  color:#ff2424;text-shadow:0 0 12px rgba(255,36,36,.35), 0 0 3px rgba(255,36,36,.8);
  user-select:none
}
.splashText .stroke{display:inline-block;position:relative}
.splashText .stroke::after{content:"";position:absolute;left:0;right:0;bottom:18%;height:8%;background:#000}
.hide{opacity:0;pointer-events:none}
@media (max-width:420px){ .setrow{grid-template-columns:1fr 1fr} .mealgrid{grid-template-columns:auto 1fr 90px 1fr} }
</style>
<script>
if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js')); }
</script>
</head>
<body>
<div id="splash"><div class="splashText"><span class="stroke">GET</span><br><span class="stroke">AFTER</span><br><span class="stroke">IT</span></div></div>

<header>
  <h1>FITNESS DAILY</h1>
  <div style="display:flex;gap:6px;align-items:center;margin-left:auto">
    <button class="btn" id="prevDay">◀</button>
    <div class="pill" id="dateLabel"></div>
    <button class="btn" id="nextDay">▶</button>
    <button class="btn alt" id="setStartBtn">Set Start</button>
    <button class="btn alt" id="setRaceBtn">Set Race</button>
    <button class="btn alt" id="dailyRemindBtn">Remind me daily</button>
  </div>
</header>

<main>
  <div class="tabs">
    <button class="tab active" id="tabTraining">Training</button>
    <button class="tab" id="tabNutrition">Nutrition</button>
    <button class="tab" id="tabRunPlan">Run Plan</button>
  </div>

  <!-- TRAINING -->
  <div id="viewTraining">
    <div class="row">
      <section class="card" style="flex:1 1 100%"><h2>Daily Motivation</h2><p class="quote" id="quoteText">Loading…</p></section>
      <section class="card" style="flex:1 1 360px">
        <h2>Today’s Run</h2>
        <p class="muted" id="runPlanLine">Set Start/Race to generate targets.</p>
        <label>Distance (km)</label><input type="number" min="0" step="0.01" id="runKm" placeholder="e.g., 5.20">
        <label>Time (hh:mm:ss)</label><input type="text" id="runTime" placeholder="e.g., 00:27:45">
        <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="saveRun">Save</button><button class="btn alt" id="clearRun">Clear day</button></div>
      </section>

      <section class="card" style="flex:2 1 480px">
        <h2 id="workoutTitle">Today’s Strength</h2>
        <div class="muted" id="workoutSubtitle">Upper A / Upper B / Legs (knee-friendly). Notes are per exercise.</div>
        <div id="liftsWrap"></div>
        <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="saveLifts">Save</button><button class="btn alt" id="clearLifts">Clear day</button></div>
      </section>

      <section class="card" style="flex:1 1 100%">
        <h2>Progress (this week)</h2>
        <div class="row">
          <div class="card" style="flex:1 1 360px"><h2>Training Volume</h2><canvas id="volChart" width="360" height="160"></canvas><p class="muted">Sum of (weight × reps) per day.</p></div>
          <div class="card" style="flex:1 1 360px"><h2>Run Distance</h2><canvas id="runChart" width="360" height="160"></canvas><p class="muted">Total kilometers per day.</p></div>
        </div>
      </section>
    </div>
  </div>

  <!-- NUTRITION -->
  <div id="viewNutrition" style="display:none">
    <div class="row">
      <section class="card" style="flex:1 1 100%">
        <h2>Master Nutrition Template (grams + drop-down swaps)</h2>
        <p class="muted">Use the chooser to swap foods from a list (no typing). Totals update from checked items. Set macro & calorie targets for progress bars.</p>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
          <button class="btn alt" id="setTargetsBtn">Set targets</button>
          <span class="smallmuted">Targets → <span id="targetsText"></span></span>
        </div>
        <div id="mealsWrap">
          <div class="meal"><div class="mealhead"><b>Breakfast</b> <span class="muted">high protein</span></div>
            <div class="mealgrid">
              <input type="checkbox" class="check" data-meal="b1" data-type="done"><div id="label-b1">Greek yogurt (2%+)</div><input type="number" min="0" value="250" data-meal="b1" data-type="g"><select data-choose="b1"></select>
              <input type="checkbox" class="check" data-meal="b2" data-type="done"><div id="label-b2">Mixed berries</div><input type="number" min="0" value="150" data-meal="b2" data-type="g"><select data-choose="b2"></select>
              <input type="checkbox" class="check" data-meal="b3" data-type="done"><div id="label-b3">Rolled oats (dry)</div><input type="number" min="0" value="60" data-meal="b3" data-type="g"><select data-choose="b3"></select>
            </div>
          </div>
          <div class="meal"><div class="mealhead"><b>Lunch</b> <span class="muted">performance carbs</span></div>
            <div class="mealgrid">
              <input type="checkbox" class="check" data-meal="l1" data-type="done"><div id="label-l1">Venison chili (lean)</div><input type="number" min="0" value="200" data-meal="l1" data-type="g"><select data-choose="l1"></select>
              <input type="checkbox" class="check" data-meal="l2" data-type="done"><div id="label-l2">Cooked white rice</div><input type="number" min="0" value="180" data-meal="l2" data-type="g"><select data-choose="l2"></select>
              <input type="checkbox" class="check" data-meal="l3" data-type="done"><div id="label-l3">Veg mix (peppers/onion/tomato)</div><input type="number" min="0" value="150" data-meal="l3" data-type="g"><select data-choose="l3"></select>
            </div>
          </div>
          <div class="meal"><div class="mealhead"><b>Dinner</b> <span class="muted">omega-3s & greens</span></div>
            <div class="mealgrid">
              <input type="checkbox" class="check" data-meal="d1" data-type="done"><div id="label-d1">Salmon (wild)</div><input type="number" min="0" value="200" data-meal="d1" data-type="g"><select data-choose="d1"></select>
              <input type="checkbox" class="check" data-meal="d2" data-type="done"><div id="label-d2">Quinoa (cooked)</div><input type="number" min="0" value="180" data-meal="d2" data-type="g"><select data-choose="d2"></select>
              <input type="checkbox" class="check" data-meal="d3" data-type="done"><div id="label-d3">Broccoli</div><input type="number" min="0" value="200" data-meal="d3" data-type="g"><select data-choose="d3"></select>
            </div>
          </div>
          <div class="meal"><div class="mealhead"><b>Snacks</b> <span class="muted">choose 1–2</span></div>
            <div class="mealgrid">
              <input type="checkbox" class="check" data-meal="s1" data-type="done"><div id="label-s1">Cottage cheese</div><input type="number" min="0" value="200" data-meal="s1" data-type="g"><select data-choose="s1"></select>
              <input type="checkbox" class="check" data-meal="s2" data-type="done"><div id="label-s2">Almonds (avoid walnuts)</div><input type="number" min="0" value="28" data-meal="s2" data-type="g"><select data-choose="s2"></select>
              <input type="checkbox" class="check" data-meal="s3" data-type="done"><div id="label-s3">Bear roast (lean, sliced)</div><input type="number" min="0" value="150" data-meal="s3" data-type="g"><select data-choose="s3"></select>
            </div>
          </div>
        </div>
        <div class="calRow">
          <div>
            <span class="macros"><b id="calTotal">0 kcal</b></span>
            <span class="bar"><span id="kBar" class="fill"></span></span><span id="kTarget" class="targetBadge"></span>
            <span class="macros" style="margin-left:16px"><b id="pTotal">P: 0 g</b></span><span class="bar"><span id="pBar" class="fill"></span></span><span id="pTarget" class="targetBadge"></span>
            <span class="macros"><b id="cTotal">C: 0 g</b></span><span class="bar"><span id="cBar" class="fill"></span></span><span id="cTarget" class="targetBadge"></span>
            <span class="macros"><b id="fTotal">F: 0 g</b></span><span class="bar"><span id="fBar" class="fill"></span></span><span id="fTarget" class="targetBadge"></span>
          </div>
        </div>
        <p class="smallmuted">Tip: Use the drop-down to swap foods. Choose “Custom…” to enter your own macros per 100 g. Your choices save on this device.</p>
        <div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="saveMeals">Save meals</button><button class="btn alt" id="clearMeals">Clear meals for day</button></div>
      </section>

      <section class="card" style="flex:1 1 100%">
        <h2>Food Substitutions (ideas)</h2>
        <div class="row">
          <div class="card"><h2>Proteins</h2><ul class="muted">
            <li>Venison ↔ elk ↔ moose ↔ bison (lean)</li><li>Bear (lean) ↔ beef round/sirloin (trimmed)</li>
            <li>Salmon ↔ trout ↔ steelhead ↔ cod/halibut</li><li>Chicken/turkey breast ↔ canned tuna/salmon</li>
            <li>Greek yogurt ↔ skyr ↔ low-fat cottage cheese</li><li>Eggs ↔ egg whites (lower fat)</li>
          </ul></div>
          <div class="card"><h2>Carbs</h2><ul class="muted">
            <li>White/jasmine/basmati/sushi rice</li><li>Quinoa ↔ farro ↔ barley ↔ couscous</li>
            <li>Oats ↔ cream of rice ↔ buckwheat</li><li><b>No sweet potatoes</b> → use white potatoes or rice</li><li>Beans/lentils ↔ chickpeas</li>
          </ul></div>
          <div class="card"><h2>Fats & Extras</h2><ul class="muted">
            <li>Olive oil ↔ avocado oil ↔ spray oil</li><li>Almonds ↔ pistachios ↔ pecans (avoid walnuts)</li>
            <li>Avocado ↔ olives</li><li>Salsas, mustard, hot sauce</li><li>Herbs/spices: garlic, dill, thyme, rosemary</li>
          </ul></div>
        </div>
      </section>
    </div>
  </div>

  <!-- RUN PLAN -->
  <div id="viewRunPlan" style="display:none">
    <section class="card"><h2>Half-Marathon Build (km)</h2>
      <p class="muted">Gentle ramp. Peak long run ~2 weeks before race. Tue easy; Thu steady/tempo; Sat long with periodic step-backs; 2-week taper.</p>
      <div id="planTable" class="muted"></div>
    </section>
  </div>
</main>

<script>
// Splash fade
window.addEventListener('load',()=>{ setTimeout(()=>{ document.getElementById('splash').classList.add('hide'); setTimeout(()=>{ const s=document.getElementById('splash'); s&&s.remove(); },450); },800); });

// Tabs
const tabTraining=document.getElementById('tabTraining'), tabNutrition=document.getElementById('tabNutrition'), tabRunPlan=document.getElementById('tabRunPlan');
const viewTraining=document.getElementById('viewTraining'), viewNutrition=document.getElementById('viewNutrition'), viewRunPlan=document.getElementById('viewRunPlan');
function showTab(which){
  tabTraining.classList.toggle('active',which==='train');
  tabNutrition.classList.toggle('active',which==='nutri');
  tabRunPlan.classList.toggle('active',which==='plan');
  viewTraining.style.display=which==='train'?'block':'none';
  viewNutrition.style.display=which==='nutri'?'block':'none';
  viewRunPlan.style.display=which==='plan'?'block':'none';
}
tabTraining.onclick=()=>showTab('train'); tabNutrition.onclick=()=>showTab('nutri'); tabRunPlan.onclick=()=>showTab('plan');

// Dates & storage
const dayMS=86400000; let current=new Date(); const dateLabel=document.getElementById('dateLabel');
function ymd(d){ return d.toISOString().slice(0,10); }
function fmt(d){ return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric',year:'numeric'}); }
const KEY='fdaily'; const db=JSON.parse(localStorage.getItem(KEY)||'{}'); function save(){ localStorage.setItem(KEY,JSON.stringify(db)); }
function getPref(k,def){ return (db['_pref_'+k]??def); } function setPref(k,v){ db['_pref_'+k]=v; save(); }
// Defaults: start=tomorrow, race fixed, nutrition targets with calories=2200
if(getPref('start',null)==null){ const t=new Date(Date.now()+dayMS); const dt=new Date(t.getFullYear(),t.getMonth(),t.getDate()); setPref('start', ymd(dt)); }
if(getPref('race',null)==null){ setPref('race','2026-06-21'); }
if(getPref('macro_K',null)==null) setPref('macro_K',2200); // *** default calories 2200 ***
if(getPref('macro_P',null)==null) setPref('macro_P',200);
if(getPref('macro_C',null)==null) setPref('macro_C',250);
if(getPref('macro_F',null)==null) setPref('macro_F',80);

document.getElementById('prevDay').onclick=()=>setDate(new Date(current.getTime()-dayMS));
document.getElementById('nextDay').onclick=()=>setDate(new Date(current.getTime()+dayMS));
document.getElementById('setStartBtn').onclick=()=>{ const s=prompt('Plan START (YYYY-MM-DD):',getPref('start')); if(s&&/^\\d{4}-\\d{2}-\\d{2}$/.test(s)){ setPref('start',s); rebuildPlan(); setDate(current);} };
document.getElementById('setRaceBtn').onclick=()=>{ const r=prompt('RACE (YYYY-MM-DD):',getPref('race')); if(r&&/^\\d{4}-\\d{2}-\\d{2}$/.test(r)){ setPref('race',r); rebuildPlan(); setDate(current);} };

// Targets UI
function showTargetsText(){
  document.getElementById('targetsText').textContent = `K ${getPref('macro_K',2200)} • P ${getPref('macro_P',200)}g • C ${getPref('macro_C',250)}g • F ${getPref('macro_F',80)}g`;
}
document.getElementById('setTargetsBtn').onclick=()=>{
  const k = prompt('Daily calories target (kcal):', getPref('macro_K',2200));
  const p = prompt('Daily protein target (g):', getPref('macro_P',200));
  const c = prompt('Daily carbs target (g):', getPref('macro_C',250));
  const f = prompt('Daily fat target (g):', getPref('macro_F',80));
  const val=(x,def)=>{const n=parseFloat(x);return isFinite(n)&&n>=0?n:def;}
  setPref('macro_K', val(k,2200)); setPref('macro_P', val(p,200)); setPref('macro_C', val(c,250)); setPref('macro_F', val(f,80));
  showTargetsText(); updateTotals();
};

// Quotes (expanded)
const QUOTES=[
  {t:"Discipline equals freedom.",a:"Jocko Willink"},
  {t:"Stay hard.",a:"David Goggins"},
  {t:"The only easy day was yesterday.",a:"Navy SEALs"},
  {t:"Tiny changes, remarkable results.",a:"Atomic Habits"},
  {t:"You do not rise to the level of your goals. You fall to the level of your systems.",a:"Atomic Habits"},
  {t:"I can accept failure; I can’t accept not trying.",a:"Michael Jordan"},
  {t:"I've failed over and over again and that is why I succeed.",a:"Michael Jordan"},
  {t:"Rest at the end, not in the middle.",a:"Kobe Bryant"},
  {t:"Greatness is not for everybody.",a:"Kobe Bryant"},
  {t:"You don’t have to be perfect, just be better than yesterday.",a:"Tom Brady"},
  {t:"Every champion is built like a brick wall. Every day, another brick.",a:"Tom Brady"},
  {t:"You miss 100% of the shots you don’t take.",a:"Wayne Gretzky"},
  {t:"Skate to where the puck is going, not where it has been.",a:"Wayne Gretzky"},
  {t:"Success is not final; failure is not fatal: it is the courage to continue that counts.",a:"Winston Churchill"},
  {t:"If you’re going through hell, keep going.",a:"Winston Churchill"},
  {t:"Let your yes be yes and your no be no.",a:"Jesus (Matthew 5:37)"},
  {t:"Whoever can be trusted with very little can also be trusted with much.",a:"Jesus (Luke 16:10)"},
  {t:"Waste no more time arguing what a good man should be. Be one.",a:"Marcus Aurelius"},
  {t:"You have power over your mind—not outside events. Realize this, and you will find strength.",a:"Marcus Aurelius"},
  {t:"We suffer more often in imagination than in reality.",a:"Seneca"},
  {t:"Luck is what happens when preparation meets opportunity.",a:"Seneca"},
  {t:"First say to yourself what you would be; then do what you have to do.",a:"Epictetus"},
  {t:"No man is free who is not master of himself.",a:"Epictetus"},
  {t:"Make your bed. Little things can change your life…and maybe the world.",a:"Adm. William H. McRaven"},
  {t:"Start where you are. Use what you have. Do what you can.",a:"Arthur Ashe"},
  {t:"Gold medals are made of sweat, determination, and a hard-to-find alloy called guts.",a:"Dan Gable"},
  {t:"It always seems impossible until it’s done.",a:"Nelson Mandela"},
  {t:"Perfection is not attainable, but if we chase perfection we can catch excellence.",a:"Vince Lombardi"},
  {t:"The man on top of the mountain didn’t fall there.",a:"Vince Lombardi"},
  {t:"Grit is passion and perseverance for very long-term goals.",a:"Angela Duckworth"},
  {t:"A good plan violently executed now is better than a perfect plan next week.",a:"Gen. George S. Patton"},
  {t:"Hard choices, easy life. Easy choices, hard life.",a:"Jerzy Gregorek"},
  {t:"Believe you can and you’re halfway there.",a:"Theodore Roosevelt"},
  {t:"Do today what others won’t, so tomorrow you can do what others can’t.",a:"Jerry Rice"},
  {t:"I hated every minute of training, but I said, 'Don't quit.'",a:"Muhammad Ali"},
  {t:"Champions keep playing until they get it right.",a:"Billie Jean King"},
  {t:"Just keep going. Everybody gets better if they keep at it.",a:"Ted Williams"},
  {t:"Be so good they can’t ignore you.",a:"Steve Martin"},
  {t:"Fall seven times and stand up eight.",a:"Japanese Proverb"},
  {t:"Pressure is a privilege.",a:"Billie Jean King"},
  {t:"A river cuts through rock because of persistence.",a:"James N. Watkins"},
  {t:"Success is never owned; it is rented—and the rent is due every day.",a:"Rory Vaden"},
  {t:"Do not pray for an easy life; pray for the strength to endure a difficult one.",a:"Bruce Lee"},
  {t:"If it doesn’t challenge you, it doesn’t change you.",a:"Fred DeVito"},
  {t:"If you want to be the best, you have to do things others aren’t willing to do.",a:"Michael Phelps"},
  {t:"Train hard, turn up, run your best and the rest will take care of itself.",a:"Usain Bolt"},
  {t:"Champions behave like champions before they’re champions.",a:"Bill Walsh"},
  {t:"The standard is the standard.",a:"Mike Tomlin"},
  {t:"Ego is the enemy.",a:"Ryan Holiday"},
  {t:"The obstacle is the way.",a:"Ryan Holiday"}
];
function showQuoteFor(d){ const seed=parseInt(ymd(d).replaceAll('-',''),10)%QUOTES.length; const q=QUOTES[seed]; document.getElementById('quoteText').innerHTML=`<b>“${q.t}”</b><br><span class="muted">— ${q.a}</span>`; }

// Strength split: Mon Upper A, Wed Upper B, Fri Legs
const UPPER_A=[
  {name:"Incline DB Press",sets:4,reps:8,key:"incline"},
  {name:"One-arm DB Row",sets:4,reps:8,key:"onearmrow"},
  {name:"Lat Pulldown",sets:3,reps:10,key:"pulldown"},
  {name:"DB Bench Press",sets:3,reps:10,key:"dbbench"},
  {name:"Face Pulls",sets:3,reps:12,key:"facepulls"}
];
const UPPER_B=[
  {name:"Pull-ups/Assisted",sets:4,reps:6,key:"pullups"},
  {name:"Barbell/DB Row",sets:4,reps:8,key:"row"},
  {name:"DB Shoulder Press",sets:4,reps:8,key:"dbpress"},
  {name:"Cable Flyes",sets:3,reps:12,key:"cablefly"},
  {name:"Hammer Curls",sets:3,reps:10,key:"hamcurl"}
];
const LEGS=[ // knee-friendly focus
  {name:"Hip Hinge (RDL)",sets:4,reps:8,key:"rdl"},
  {name:"Hip Thrust (light/mod)",sets:3,reps:10,key:"hipthrust"},
  {name:"Step-ups (low box)",sets:3,reps:10,key:"stepup"},
  {name:"Sled Push/Walk (m)",sets:6,reps:20,key:"sled"},
  {name:"Plank (sec)",sets:3,reps:45,key:"plank"}
];

function dayDiff(a,b){ return Math.floor((b-a)/(24*60*60*1000)); }
function weekIndex(startStr,d){ const start=new Date(startStr+'T00:00:00'); const diff=dayDiff(start,d); return Math.max(0, Math.floor(diff/7)); }
function workoutForDate(d){
  const dow=d.getDay(); // 0 Sun..6 Sat
  if(dow===1) return {title:"Upper A (Mon)", list:UPPER_A};
  if(dow===3) return {title:"Upper B (Wed)", list:UPPER_B};
  if(dow===5) return {title:"Legs (Fri)", list:LEGS};
  return {title:"Accessory / Recovery", list:[]};
}
const liftsWrap=document.getElementById('liftsWrap');
function liftRowHTML(key,name,sets,reps){
  let rows=''; for(let i=1;i<=sets;i++){ rows+=`<div class="setrow" data-lift="${key}"><input type="number" min="0" placeholder="Weight" data-lift="${key}" data-field="w${i}"><input type="number" min="0" placeholder="Reps (${reps})" data-lift="${key}" data-field="r${i}"></div>`; }
  return `<div class="lift"><div><b>${name}</b> — ${sets}×${reps}</div>${rows}<label>Notes</label><textarea data-lift="${key}" data-field="notes" placeholder="Form cues, effort, knee status…"></textarea></div>`;
}
function renderWorkout(d){
  const wk=workoutForDate(d);
  document.getElementById('workoutTitle').textContent=wk.title||"Today’s Strength";
  document.getElementById('workoutSubtitle').textContent=wk.list.length?"Log your actual weights/reps. Notes are per exercise.":"Run/mobility day or rest.";
  liftsWrap.innerHTML=wk.list.length?wk.list.map(x=>liftRowHTML(x.key,x.name,x.sets,x.reps)).join(""):`<div class="muted">No main lifts scheduled.</div>`;
}

// Persist lifts
function liftKey(){return"lift:"+ymd(current);} 
function loadLifts(){const obj=db[liftKey()]||{};document.querySelectorAll('[data-lift]').forEach(el=>{const id=el.dataset.lift+":"+el.dataset.field;if(obj[id]!==undefined)el.value=obj[id];});}
function persistLifts(){const obj={};document.querySelectorAll('[data-lift]').forEach(el=>{const id=el.dataset.lift+":"+el.dataset.field;if(el.value&&el.value.toString().trim()!=="")obj[id]=el.value;});db[liftKey()]=obj;save();drawCharts();}
document.getElementById('saveLifts').onclick=persistLifts;document.getElementById('clearLifts').onclick=()=>{delete db[liftKey()];save();renderWorkout(current);};

// Progressive run plan: Tue/Thu/Sat (Sat long), gentle ramp, peak ~2w pre-race
function runTargetFor(d){
  const startStr=getPref('start'); const raceStr=getPref('race'); const start=new Date(startStr+'T00:00:00'); const race=new Date(raceStr+'T00:00:00');
  const totalWeeks=Math.max(1, Math.floor((race-start)/(7*24*3600*1000)));
  const wk=weekIndex(startStr,d); const dow=d.getDay();
  const weeksToRace=Math.max(0, Math.floor((race - d)/(7*24*3600*1000)));

  // Long run growth: 5 km baseline -> 19-20 km peak 2 weeks out; step-back each 4th week
  const startLong=5, peakLong=19, peakWeek=Math.max(1,totalWeeks-2);
  let plannedLong = startLong + (peakLong-startLong) * Math.min(wk,peakWeek)/peakWeek;
  if((wk+1)%4===0) plannedLong = Math.max(6, Math.round(plannedLong*0.85)); // step-back
  if(weeksToRace<=1) plannedLong = Math.round(plannedLong*0.5); // race week
  else if(weeksToRace===2) plannedLong = peakLong; // peak 2w out

  // Tue & Thu scale gently from 3–7 and 4–9 km
  let tue = 3 + Math.floor(wk/3)*0.5; if(tue>7) tue=7;
  let thu = 4 + Math.floor(wk/3)*0.5; if(thu>9) thu=9;

  let type='Rest', km=0;
  if(dow===2){type='Easy run'; km=tue;}
  if(dow===4){type='Steady/Tempo'; km=thu;}
  if(dow===6){type='Long run'; km=plannedLong;}
  return {type,km};
}
const runPlanLine=document.getElementById('runPlanLine');const kmEl=document.getElementById('runKm'),timeEl=document.getElementById('runTime');
function runKey(){return"run:"+ymd(current);} 
function loadRun(){const tgt=runTargetFor(current);runPlanLine.textContent=(tgt.km>0)?`Target: ${tgt.km.toFixed(1)} km — ${tgt.type}`:`Target: Rest / Mobility`;const r=db[runKey()]||{};kmEl.value=r.km??"";timeEl.value=r.t??"";}
function persistRun(){db[runKey()]={km:kmEl.value,t:timeEl.value};save();drawCharts();}
document.getElementById('saveRun').onclick=persistRun;document.getElementById('clearRun').onclick=()=>{delete db[runKey()];save();loadRun();};

// Charts
function parseNum(x){const n=parseFloat(x);return isFinite(n)?n:0;}
function volumeForDay(s){const obj=db["lift:"+s]||{};let vol=0;Object.entries(obj).forEach(([k,v])=>{if(k.includes(":w")){const reps=parseNum(obj[k.replace(":w",":r")]||0);vol+=parseNum(v)*reps;}});return vol;}
function runKmForDay(s){const r=db["run:"+s]||{};return parseNum(r.km||0);}
function weekDays(base){const d=new Date(base);const day=(d.getDay()+6)%7;d.setDate(d.getDate()-day);return[...Array(7)].map((_,i)=>{const t=new Date(d);t.setDate(d.getDate()+i);return t;});}
function drawBar(ctx,data,max){const W=ctx.canvas.width,H=ctx.canvas.height;ctx.clearRect(0,0,W,H);ctx.fillStyle="#0f1116";ctx.fillRect(0,0,W,H);const pad=24,n=data.length,step=(W-pad*2)/n,bw=Math.max(6,step*0.6);ctx.strokeStyle="#22272e";ctx.beginPath();ctx.moveTo(pad,H-pad);ctx.lineTo(W-pad,H-pad);ctx.stroke();data.forEach((v,i)=>{const x=pad+i*step+(step-bw)/2;const h=max?Math.round((v/max)*(H-pad*2)):0;ctx.fillStyle="#ff2424";ctx.fillRect(x,H-pad-h,bw,h);});}
function drawCharts(){const days=weekDays(current).map(d=>d.toISOString().slice(0,10));const vols=days.map(volumeForDay),kms=days.map(runKmForDay);const vMax=Math.max(10,...vols),kMax=Math.max(1,...kms);drawBar(document.getElementById('volChart').getContext('2d'),vols,vMax);drawBar(document.getElementById('runChart').getContext('2d'),kms,kMax);}

// Nutrition with dropdown swaps + macros + targets
const BASE_MACROS={
  b1:{name:"Greek yogurt (2%+)",k:97,p:10,c:4,f:3},
  b2:{name:"Mixed berries",k:57,p:1,c:14,f:0.3},
  b3:{name:"Rolled oats (dry)",k:379,p:13,c:67,f:7},
  l1:{name:"Venison chili (lean)",k:120,p:16,c:8,f:3},
  l2:{name:"Cooked white rice",k:130,p:2.4,c:28,f:0.3},
  l3:{name:"Veg mix",k:40,p:2,c:9,f:0.2},
  d1:{name:"Salmon (wild)",k:208,p:22,c:0,f:13},
  d2:{name:"Quinoa (cooked)",k:120,p:4.4,c:21,f:1.9},
  d3:{name:"Broccoli",k:35,p:2.4,c:7,f:0.4},
  s1:{name:"Cottage cheese",k:98,p:11,c:3.4,f:4.3},
  s2:{name:"Almonds",k:579,p:21,c:22,f:50},
  s3:{name:"Bear roast (lean)",k:165,p:30,c:0,f:4}
};
const FOOD_LIBRARY={
  "Greek yogurt (2%+)":{k:97,p:10,c:4,f:3}, "Skyr":{k:63,p:11,c:3.9,f:0.2}, "Cottage cheese":{k:98,p:11,c:3.4,f:4.3},
  "Eggs (whole)":{k:143,p:12.6,c:1.1,f:9.5}, "Egg whites":{k:52,p:10.9,c:0.7,f:0.2},
  "Mixed berries":{k:57,p:1,c:14,f:0.3}, "Banana":{k:89,p:1.1,c:23,f:0.3}, "Apple":{k:52,p:0.3,c:14,f:0.2},
  "Rolled oats (dry)":{k:379,p:13,c:67,f:7}, "Cream of rice (dry)":{k:370,p:6.7,c:82,f:0.7},
  "Venison (lean, cooked)":{k:158,p:30,c:0,f:3.2}, "Elk (lean, cooked)":{k:148,p:30,c:0,f:2.3}, "Moose (lean, cooked)":{k:133,p:28,c:0,f:1.2}, "Bison (lean, cooked)":{k:171,p:29,c:0,f:6},
  "Lean beef round (cooked)":{k:217,p:27,c:0,f:11}, "Bear (lean, cooked)":{k:165,p:30,c:0,f:4},
  "Cooked white rice":{k:130,p:2.4,c:28,f:0.3}, "Cooked jasmine rice":{k:129,p:2.7,c:28,f:0.3}, "Cooked basmati rice":{k:121,p:3.5,c:25,f:0.4},
  "Quinoa (cooked)":{k:120,p:4.4,c:21,f:1.9}, "Farro (cooked)":{k:125,p:4.2,c:26,f:0.9}, "Barley (cooked)":{k:123,p:2.3,c:28,f:0.4}, "Couscous (cooked)":{k:112,p:3.8,c:23,f:0.2},
  "Veg mix":{k:40,p:2,c:9,f:0.2}, "Broccoli":{k:35,p:2.4,c:7,f:0.4}, "Peppers & onions":{k:32,p:1.1,c:7,f:0.1},
  "Salmon (wild)":{k:208,p:22,c:0,f:13}, "Trout":{k:190,p:20,c:0,f:13}, "Steelhead":{k:170,p:20,c:0,f:10}, "Cod":{k:82,p:18,c:0,f:0.7}, "Halibut":{k:111,p:23,c:0,f:2.3}, "Chicken breast (cooked)":{k:165,p:31,c:0,f:3.6}, "Turkey breast (cooked)":{k:135,p:29,c:0,f:1},
  "Almonds":{k:579,p:21,c:22,f:50}, "Pistachios":{k:562,p:20,c:28,f:45}, "Pecans":{k:691,p:9,c:14,f:72},
  "Bear roast (lean)":{k:165,p:30,c:0,f:4},
  "Custom…":{k:0,p:0,c:0,f:0}
};
const overrides = JSON.parse(localStorage.getItem('fdaily_food_overrides')||'{}');
function getFood(id){ return overrides[id] || BASE_MACROS[id]; }
function saveOverrides(){ localStorage.setItem('fdaily_food_overrides', JSON.stringify(overrides)); }

// Build dropdowns
function fillDropdowns(){ document.querySelectorAll('[data-choose]').forEach(sel=>{
  const id=sel.getAttribute('data-choose'); sel.innerHTML=''; for(const name in FOOD_LIBRARY){ const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt); }
  sel.value=getFood(id).name || BASE_MACROS[id].name;
  sel.addEventListener('change',()=>{
    const name=sel.value;
    if(name==='Custom…'){
      const base=getFood(id);
      const n=prompt('Custom food name:', base.name||'My food'); if(!n) return;
      const k=prompt('kcal per 100 g:', base.k); const p=prompt('protein per 100 g (g):', base.p); const c=prompt('carbs per 100 g (g):', base.c); const f=prompt('fat per 100 g (g):', base.f);
      const toNum=(x,def)=>{const v=parseFloat(x);return isFinite(v)?v:def;};
      overrides[id]={name:n,k:toNum(k,base.k),p:toNum(p,base.p),c:toNum(c,base.c),f:toNum(f,base.f)}; saveOverrides(); document.getElementById('label-'+id).textContent=n;
    } else {
      const macro=FOOD_LIBRARY[name]; overrides[id]={name:name,k:macro.k,p:macro.p,c:macro.c,f:macro.f}; saveOverrides(); document.getElementById('label-'+id).textContent=name;
    }
    updateTotals();
  });
});}

// Meals persistence & totals
const calTotalEl=document.getElementById('calTotal'), pTotalEl=document.getElementById('pTotal'), cTotalEl=document.getElementById('cTotal'), fTotalEl=document.getElementById('fTotal');
const kBar=document.getElementById('kBar'), pBar=document.getElementById('pBar'), cBar=document.getElementById('cBar'), fBar=document.getElementById('fBar'); 
const kTarget=document.getElementById('kTarget'), pTarget=document.getElementById('pTarget'), cTarget=document.getElementById('cTarget'), fTarget=document.getElementById('fTarget');
const mealInputs=[...document.querySelectorAll('[data-meal]')];
function mealKey(){return 'meals:'+ymd(current);}
function loadMeals(){
  const obj=db[mealKey()]||{};
  mealInputs.forEach(el=>{ const id=el.dataset.meal+':'+el.dataset.type; if(el.type==='checkbox') el.checked=!!obj[id]; else if(el.type==='number') el.value=obj[id]??el.value; });
  Object.keys(BASE_MACROS).forEach(id=>{ const lbl=document.getElementById('label-'+id); if(lbl){ lbl.textContent=getFood(id).name; } });
  fillDropdowns(); updateTotals();
}
function persistMeals(){ const obj={}; mealInputs.forEach(el=>{ const id=el.dataset.meal+':'+el.dataset.type; if(el.type==='checkbox'){ if(el.checked) obj[id]=true; } else if(el.type==='number'){ obj[id]=el.value; } }); db[mealKey()]=obj; save(); updateTotals(); alert('Meals saved for '+ymd(current)); }
function clearMeals(){ delete db[mealKey()]; save(); loadMeals(); }
document.getElementById('saveMeals').onclick=persistMeals; document.getElementById('clearMeals').onclick=clearMeals;
function gramsFor(id){ const el=[...document.querySelectorAll(`[data-meal="${id}"][data-type="g"]`)][0]; return parseFloat(el?.value||'0')||0; }
function checked(id){ const el=[...document.querySelectorAll(`[data-meal="${id}"][data-type="done"]`)][0]; return !!el?.checked; }
function clamp01(x){return Math.max(0,Math.min(1,x));}
function updateTotals(){
  // Sum only checked rows
  let kcal=0, P=0, C=0, F=0;
  for(const id of Object.keys(BASE_MACROS)){
    if(checked(id)){
      const g=gramsFor(id); const m=getFood(id);
      kcal+=m.k*g/100; P+=m.p*g/100; C+=m.c*g/100; F+=m.f*g/100;
    }
  }
  kcal=Math.round(kcal); P=Math.round(P); C=Math.round(C); F=Math.round(F);
  calTotalEl.textContent=kcal+" kcal"; pTotalEl.textContent="P: "+P+" g"; cTotalEl.textContent="C: "+C+" g"; fTotalEl.textContent="F: "+F+" g";
  // Progress bars (fixed)
  const kt=getPref('macro_K',2200), pt=getPref('macro_P',200), ct=getPref('macro_C',250), ft=getPref('macro_F',80);
  kBar.style.width=(clamp01(kcal/kt)*100)+'%'; kTarget.textContent=`/ ${kt} kcal`;
  pBar.style.width=(clamp01(P/pt)*100)+'%'; pTarget.textContent=`/ ${pt} g`;
  cBar.style.width=(clamp01(C/ct)*100)+'%'; cTarget.textContent=`/ ${ct} g`;
  fBar.style.width=(clamp01(F/ft)*100)+'%'; fTarget.textContent=`/ ${ft} g`;
}
mealInputs.forEach(el=>{ el.addEventListener('input',updateTotals); el.addEventListener('change',updateTotals); });

// Plan table render (week by week, Tue/Thu/Sat runs)
function rebuildPlan(){
  const cont=document.getElementById('planTable'); cont.innerHTML='';
  const start=new Date(getPref('start')+'T00:00:00'); const race=new Date(getPref('race')+'T00:00:00');
  let d=new Date(start);
  while(d<=race){
    const days=[...Array(7)].map((_,i)=>{const t=new Date(d); t.setDate(d.getDate()+i); return t;});
    const hdr=`<tr style="background:#101318"><th style="padding:6px 8px;border:1px solid var(--line)">Mon</th><th style="padding:6px 8px;border:1px solid var(--line)">Tue</th><th style="padding:6px 8px;border:1px solid var(--line)">Wed</th><th style="padding:6px 8px;border:1px solid var(--line)">Thu</th><th style="padding:6px 8px;border:1px solid var(--line)">Fri</th><th style="padding:6px 8px;border:1px solid var(--line)">Sat</th><th style="padding:6px 8px;border:1px solid var(--line)">Sun</th></tr>`;
    const tds = days.map(dd=>{ const tgt=runTargetFor(dd); const lbl = dd.getDay()==2||dd.getDay()==4||dd.getDay()==6 ? (tgt.km>0 ? (tgt.km.toFixed(1)+'k') : '—') : '—'; const subt = (dd.getDay()==2||dd.getDay()==4||dd.getDay()==6) ? tgt.type.split(' ')[0] : ''; return `<td style="padding:6px 8px;border:1px solid var(--line)">${lbl}<br><span style='font-size:11px;color:#9aa3b2'>${subt}</span></td>`; }).join('');
    cont.innerHTML += `<table style="width:100%;border-collapse:collapse;margin:10px 0">${hdr}<tr>${tds}</tr></table>`;
    d.setDate(d.getDate()+7);
  }
}

// Reminders (download ICS)
function downloadDailyICS(title='GET AFTER IT — open Fitness Daily',hour=7,minute=0){
  const now=new Date(); const pad=n=>String(n).padStart(2,'0'); const y=now.getFullYear(),m=pad(now.getMonth()+1),d=pad(now.getDate()); const hh=pad(hour),mm=pad(minute);
  const dtstart=`${y}${m}${d}T${hh}${mm}00`; const uid=`fdaily-${Date.now()}@fitness`;
  const ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//FitnessDaily//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH','BEGIN:VEVENT',`UID:${uid}`,`DTSTART:${dtstart}`,'RRULE:FREQ=DAILY',`SUMMARY:${title}`,'END:VEVENT','END:VCALENDAR'].join('\r\n');
  const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='FitnessDaily_Daily_Reminder.ics'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),800);
}
document.getElementById('dailyRemindBtn').onclick=()=>{ const t=prompt('Daily reminder time (24h, e.g. 06:30). Leave blank for 07:00:',''); let h=7,m=0; if(t&&/^\d{1,2}:\d{2}$/.test(t.trim())){ const[hh,mm]=t.split(':').map(x=>parseInt(x,10)); if(hh>=0&&hh<24&&mm>=0&&mm<60){h=hh;m=mm;} } downloadDailyICS('GET AFTER IT — open Fitness Daily',h,m); alert('ICS downloaded. Tap it → Add.'); };

// INIT
function setDate(d){
  current=new Date(d.getFullYear(),d.getMonth(),d.getDate());
  dateLabel.textContent=fmt(current);
  showTargetsText();
  showQuoteFor(current);
  renderWorkout(current);
  loadLifts();
  loadRun();
  loadMeals();
  drawCharts();
}
rebuildPlan();
setDate(new Date());
</script>
</body></html>
